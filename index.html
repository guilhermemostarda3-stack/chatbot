<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatBot Completo</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #6e8efb, #a777e3);
        color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      body.dark-mode {
        background: linear-gradient(135deg, #1a1a1a, #333);
        color: #fff;
      }
      #chat-wrapper {
        width: 1200px;
        height: 650px;
        margin: 20px auto;
        display: flex;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        background: #fff;
        border: 5px solid #4caf50;
      }
      body.dark-mode #chat-wrapper {
        background: #2b2b2b;
        border-color: #333;
      }
      #side-panel {
        width: 300px;
        background-color: #f0f0f0;
        border-right: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        padding: 15px;
        gap: 10px;
      }
      body.dark-mode #side-panel {
        background-color: #1a1a1a;
        border-color: #333;
        color: #eee;
      }
      #chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
        border-right: 1px solid #ccc;
      }
      body.dark-mode #chat-history {
        background-color: #2b2b2b;
        border-color: #333;
        color: #fff;
      }
      .chat-entry {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.2s;
      }
      .chat-entry:hover {
        background-color: #e0e0e0;
      }
      body.dark-mode .chat-entry:hover {
        background-color: #444;
      }
      .chat-entry-title {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .delete-chat-btn {
        background: none;
        border: none;
        color: #d32f2f;
        font-size: 16px;
        cursor: pointer;
        margin-left: 10px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .delete-chat-btn:hover {
        opacity: 1;
      }
      #main-chat {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: #f9f9f9;
        position: relative;
      }
      body.dark-mode #main-chat {
        background: #1f1f1f;
      }
      #messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .message-wrapper {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        position: relative;
      }
      .message-wrapper.user {
        align-items: flex-end;
      }
      .message {
        padding: 12px 18px;
        border-radius: 20px;
        max-width: 70%;
        line-height: 1.5;
        font-size: 16px;
      }
      .message.user {
        background-color: #6e8efb;
        color: #fff;
        border-bottom-right-radius: 0;
      }
      .message.bot {
        background-color: #e0e0e0;
        color: #333;
        border-bottom-left-radius: 0;
      }
      body.dark-mode .message.bot {
        background-color: #333;
        color: #fff;
      }
      .msg-actions {
        display: flex;
        gap: 5px;
        margin-top: 5px;
      }
      .msg-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #888;
      }
      body.dark-mode .msg-actions button {
        color: #bbb;
      }
      #input-container {
        padding: 10px 20px;
        border-top: 1px solid #ccc;
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fff;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
      body.dark-mode #input-container {
        background: #2b2b2b;
        border-color: #333;
      }
      #user-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 20px;
        outline: none;
        font-size: 16px;
        transition: border-color 0.3s;
      }
      #user-input:focus {
        border-color: #4caf50;
      }
      body.dark-mode #user-input {
        background: #333;
        border-color: #555;
        color: #fff;
      }
      #send-btn,
      #add-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        background-color: #4caf50;
        color: #fff;
        font-size: 18px;
        transition: background-color 0.3s, transform 0.1s;
      }
      #send-btn:hover,
      #add-btn:hover {
        background-color: #45a049;
        transform: scale(1.05);
      }
      .typing-indicator {
        font-style: italic;
        color: #888;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.5;
        }
      }
      #file-menu-dropdown {
        position: absolute;
        bottom: 70px;
        right: 20px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        z-index: 1000;
        overflow: hidden;
      }
      body.dark-mode #file-menu-dropdown {
        background: #333;
        border-color: #555;
      }
      .dropdown-item {
        padding: 10px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background-color 0.2s;
      }
      .dropdown-item:hover {
        background-color: #f0f0f0;
      }
      body.dark-mode .dropdown-item:hover {
        background-color: #444;
      }
      .dropdown-item i {
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div id="chat-wrapper">
      <div id="side-panel">
        <h2>Hist√≥rico</h2>
        <div id="chat-history"></div>
        <button id="new-chat-btn">Nova conversa</button>
      </div>

      <div id="main-chat">
        <div id="messages"></div>
        <div id="input-container">
          <button id="add-btn">+</button>
          <input
            type="text"
            id="user-input"
            placeholder="Digite sua mensagem..."
          />
          <button id="send-btn">Enviar</button>
        </div>
        <div id="file-menu-dropdown">
          <div class="dropdown-item" id="btn-pdf">
            <span>Arquivo PDF</span>
          </div>
          <div class="dropdown-item" id="btn-word">
            <span>Arquivo Word</span>
          </div>
          <div class="dropdown-item" id="btn-txt">
            <span>Arquivo de Texto</span>
          </div>
        </div>
      </div>
    </div>
    <input type="file" id="upload-file" style="display: none" />
    <script src="https://js.puter.com/v2/"></script>
    <script>
      const GIPHY_API_KEY = "eLIbdvWpV2XcSqhAIEYS5Bf7E47lLaRG";
      const userInput = document.getElementById("user-input");
      const messagesContainer = document.getElementById("messages");
      const chatHistoryContainer = document.getElementById("chat-history");
      const newChatBtn = document.getElementById("new-chat-btn");
      const uploadFile = document.getElementById("upload-file");
      const btnPdf = document.getElementById("btn-pdf");
      const btnWord = document.getElementById("btn-word");
      const btnTxt = document.getElementById("btn-txt");

      let currentChat = [];
      let allChats = JSON.parse(localStorage.getItem("allChats")) || {};
      let currentChatId = null;
      let isEditing = false;
      let botTypingIndicator = null;
      let puterModel = null;

      function generateUniqueId() {
        return "chat-" + Date.now();
      }

      function createNewChat() {
        currentChatId = generateUniqueId();
        currentChat = [];
        allChats[currentChatId] = currentChat;
        saveChats();
        renderCurrentChat();
        renderChatHistory();
        userInput.focus();
      }

      function saveChats() {
        localStorage.setItem("allChats", JSON.stringify(allChats));
        renderChatHistory();
      }

      function renderChatHistory() {
        chatHistoryContainer.innerHTML = "";
        for (const id in allChats) {
          const chat = allChats[id];
          const entry = document.createElement("div");
          entry.className = "chat-entry";
          entry.setAttribute("data-id", id);
          const firstMessage =
            chat.length > 0
              ? chat[0].message.substring(0, 30) + "..."
              : "Nova conversa";
          entry.innerHTML = `
                <span class="chat-entry-title">${firstMessage}</span>
                <button class="delete-chat-btn" data-id="${id}">üóëÔ∏è</button>
            `;
          entry.onclick = (e) => {
            if (!e.target.classList.contains("delete-chat-btn")) {
              loadChat(id);
            }
          };
          chatHistoryContainer.appendChild(entry);
        }
      }

      function loadChat(id) {
        currentChatId = id;
        currentChat = allChats[id];
        renderCurrentChat();
      }

      function deleteChat(id) {
        delete allChats[id];
        saveChats();
        if (currentChatId === id) {
          createNewChat();
        }
      }

      function renderCurrentChat() {
        messagesContainer.innerHTML = "";
        currentChat.forEach((msg, index) => {
          appendMessage(msg.sender, msg.message, msg.id);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function appendMessage(sender, message, id) {
        const msgWrapper = document.createElement("div");
        msgWrapper.className = `message-wrapper ${sender}`;
        msgWrapper.setAttribute("data-id", id);

        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${sender}`;
        msgDiv.innerHTML = `<p>${message}</p>`;

        msgWrapper.appendChild(msgDiv);
        messagesContainer.appendChild(msgWrapper);

        if (sender === "bot") {
          const actionsContainer = document.createElement("div");
          actionsContainer.className = "msg-actions";

          const editBtn = document.createElement("button");
          editBtn.innerText = "‚úèÔ∏è";
          editBtn.onclick = () => {
            if (!isEditing) startEdit(id);
          };

          const copyBtn = document.createElement("button");
          copyBtn.innerText = "üìã";
          copyBtn.onclick = () => copyText(id);

          actionsContainer.appendChild(editBtn);
          actionsContainer.appendChild(copyBtn);
          msgWrapper.appendChild(actionsContainer);
        }

        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTypingIndicator() {
        if (!botTypingIndicator) {
          botTypingIndicator = document.createElement("div");
          botTypingIndicator.className = "message bot typing-indicator";
          botTypingIndicator.innerText = "Digitando...";
          messagesContainer.appendChild(botTypingIndicator);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      function hideTypingIndicator() {
        if (botTypingIndicator) {
          botTypingIndicator.remove();
          botTypingIndicator = null;
        }
      }

      function addMessageToChat(sender, message) {
        const id = generateUniqueId();
        currentChat.push({ id, sender, message });
        saveChats();
        return id;
      }

      async function sendMessage() {
        const message = userInput.value.trim();
        if (message === "") return;

        if (currentChatId === null) {
          createNewChat();
        }

        addMessageToChat("user", message);
        appendMessage("user", message, generateUniqueId());
        userInput.value = "";

        showTypingIndicator();

        const isImageRequest =
          message.toLowerCase().includes("foto") ||
          message.toLowerCase().includes("imagem");

        if (isImageRequest) {
          let imageSearchTerm = message
            .toLowerCase()
            .replace(/^(quero uma\s+)?(foto|imagem)\s+(de\s+)?/, "")
            .trim();
          await searchAndDisplayImage(imageSearchTerm);
        } else {
          await generatePuterResponse(message);
        }
      }

      async function searchAndDisplayImage(searchTerm) {
        try {
          const encodedSearchTerm = encodeURIComponent(searchTerm);
          const url = `https://api.giphy.com/v1/gifs/random?api_key=${GIPHY_API_KEY}&tag=${encodedSearchTerm}&rating=g`;
          const response = await fetch(url);
          const data = await response.json();

          hideTypingIndicator();

          const botMessageWrapper = document.createElement("div");
          botMessageWrapper.className = `message-wrapper bot`;
          const botMessageElement = document.createElement("div");
          botMessageElement.className = "message bot";
          botMessageWrapper.appendChild(botMessageElement);

          if (data.data && data.data.images) {
            const imageUrl = data.data.images.original.url;
            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            imgElement.alt = `Imagem de ${searchTerm}`;
            imgElement.style.maxWidth = "100%";
            imgElement.style.height = "auto";
            imgElement.style.borderRadius = "8px";
            botMessageElement.appendChild(imgElement);
            addMessageToChat("bot", `<img src="${imageUrl}">`);
          } else {
            const noImageMsg = `Desculpe, n√£o encontrei nenhuma imagem para "${searchTerm}".`;
            botMessageElement.innerHTML = `<p>${noImageMsg}</p>`;
            addMessageToChat("bot", noImageMsg);
          }
          messagesContainer.appendChild(botMessageWrapper);
        } catch (error) {
          console.error("Erro ao buscar a imagem:", error);
          hideTypingIndicator();
          const errorMsg =
            "Ocorreu um erro ao carregar a imagem. Tente novamente mais tarde.";
          addMessageToChat("bot", errorMsg);
          appendMessage("bot", errorMsg, generateUniqueId());
        } finally {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      async function generatePuterResponse(message) {
        try {
          if (!puterModel) {
            puterModel = puter.ai.GenerativeModel({
              model: "gemini-1.5-flash",
            });
          }
          const result = await puterModel.generateContent({
            contents: [{ role: "user", parts: [{ text: message }] }],
          });
          if (result.response && result.response.candidates.length > 0) {
            const botResponseText = result.response.candidates[0].content.parts[0].text;
            addMessageToChat("bot", botResponseText);
            hideTypingIndicator();
            appendMessage("bot", botResponseText, generateUniqueId());
          } else {
            throw new Error("Resposta vazia do modelo.");
          }
        } catch (e) {
          console.error("Erro ao gerar conte√∫do:", e);
          const errorMsg =
            "Desculpe, n√£o consegui gerar uma resposta. Tente novamente mais tarde.";
          addMessageToChat("bot", errorMsg);
          hideTypingIndicator();
          appendMessage("bot", errorMsg, generateUniqueId());
        } finally {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      function startEdit(id) {
        isEditing = true;
        const msgWrapper = document.querySelector(
          `.message-wrapper[data-id="${id}"]`
        );
        const msgDiv = msgWrapper.querySelector(".message");
        const originalText = msgDiv.innerText;

        const editInput = document.createElement("textarea");
        editInput.value = originalText;
        editInput.style.width = "100%";
        editInput.style.height = "100px";

        msgDiv.innerHTML = "";
        msgDiv.appendChild(editInput);

        const actionsContainer = msgWrapper.querySelector(".msg-actions");
        actionsContainer.style.display = "none";

        const editActions = document.createElement("div");
        editActions.className = "edit-actions";
        const saveBtn = document.createElement("button");
        saveBtn.innerText = "Salvar";
        saveBtn.onclick = () => saveEdit(id, editInput.value);

        const cancelBtn = document.createElement("button");
        cancelBtn.innerText = "Cancelar";
        cancelBtn.onclick = () => cancelEdit(id, originalText);

        editActions.appendChild(saveBtn);
        editActions.appendChild(cancelBtn);
        msgWrapper.appendChild(editActions);
      }

      function saveEdit(id, newText) {
        const msgIndex = currentChat.findIndex((msg) => msg.id === id);
        if (msgIndex !== -1) {
          currentChat[msgIndex].message = newText;
          saveChats();
        }
        isEditing = false;
        renderCurrentChat();
      }

      function cancelEdit(id, originalText) {
        isEditing = false;
        renderCurrentChat();
      }

      function copyText(id) {
        const msg = currentChat.find((m) => m.id === id);
        if (msg) {
          navigator.clipboard.writeText(msg.message);
          alert("Mensagem copiada!");
        }
      }

      document
        .getElementById("send-btn")
        .addEventListener("click", () => sendMessage());
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });
      newChatBtn.addEventListener("click", createNewChat);
      document.getElementById("add-btn").addEventListener("click", () => {
        const dropdown = document.getElementById("file-menu-dropdown");
        dropdown.style.display =
          dropdown.style.display === "flex" ? "none" : "flex";
      });
      btnPdf.onclick = () => uploadFile.click();
      btnWord.onclick = () => uploadFile.click();
      btnTxt.onclick = () => uploadFile.click();

      document.body.addEventListener("click", (e) => {
        if (
          !e.target.closest("#add-btn") &&
          !e.target.closest("#file-menu-dropdown")
        ) {
          const dropdown = document.getElementById("file-menu-dropdown");
          dropdown.style.display = "none";
        }
      });

      window.addEventListener("load", () => {
        if (Object.keys(allChats).length === 0) {
          createNewChat();
        } else {
          loadChat(Object.keys(allChats)[0]);
        }
        renderChatHistory();
      });

      const themeToggleBtn = document.createElement("button");
      themeToggleBtn.innerText = "üåô";
      themeToggleBtn.style.cssText =
        "position: fixed; bottom: 20px; right: 20px; font-size: 24px; background: #fff; border-radius: 50%; width: 50px; height: 50px; border: 2px solid #ccc; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);";
      themeToggleBtn.onclick = () => {
        document.body.classList.toggle("dark-mode");
      };
      document.body.appendChild(themeToggleBtn);
    </script>
  </body>
</html>

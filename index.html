<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatBot Completo</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #6e8efb, #a777e3);
        color: #000;
      }
      body.dark-mode {
        background: linear-gradient(135deg, #1a1a1a, #333);
        color: #fff;
      }
      #chat-wrapper {
        width: 1200px; /* Largura ajustada */
        height: 650px;
        margin: 20px auto;
        display: flex;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        background: #fff;
        border: 5px solid #4caf50;
      }
      body.dark-mode #chat-wrapper {
        background: #1e1e1e;
        border: 5px solid #2e7d32;
      }
      #sidebar {
        width: 260px;
        background: rgba(224, 255, 224, 0.8);
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 10px;
        overflow-y: auto;
        border-right: 2px solid #4caf50;
      }
      body.dark-mode #sidebar {
        background: #222;
        border-right: 2px solid #2e7d32;
      }
      .sidebar-btn {
        padding: 12px;
        border-radius: 18px;
        background: #ccc;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s;
        position: relative;
      }
      .sidebar-btn.active {
        background: #4caf50;
        color: #fff;
        font-weight: bold;
        border: 2px solid #2e7d32;
      }
      .sidebar-btn:hover {
        background: #66bb6a;
      }
      .chat-menu {
        position: absolute;
        top: 40px;
        right: 10px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 10;
        display: none;
        flex-direction: column;
      }
      .chat-menu button {
        background: none;
        border: none;
        padding: 10px;
        cursor: pointer;
        text-align: left;
        color: #333;
        font-size: 14px;
      }
      .chat-menu button:hover {
        background: #f0f0f0;
      }
      #chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        background: #f9f9f9;
      }
      body.dark-mode #chat-area {
        background: #222;
      }
      #chat-header {
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #4caf50;
        color: white;
      }
      #chat-header button,
      #chat-header input[type="file"] {
        padding: 6px 12px;
        border: none;
        border-radius: 25px;
        background: #66bb6a;
        color: white;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      /* Novo CSS para o nome */
      .chatbot-profile {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .chatbot-profile span {
        font-weight: bold;
        font-size: 1.2rem;
      }
      /* Fim do novo CSS */
      #download-buttons {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      #download-buttons button {
        white-space: nowrap;
      }
      #search-container {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
      }
      #search-container input {
        padding: 16px 20px;
        font-size: 1.1rem;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
        width: calc(100% - 40px);
        margin: 0 auto;
        display: block;
      }
      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .message-wrapper {
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease;
        position: relative;
      }
      .message {
        padding: 16px 20px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        line-height: 1.4;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .message.user {
        background: #dcf8c6;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }
      .message.bot {
        background: #ffffff;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
      }
      .message.pinned {
        border: 2px solid gold;
      }
      .msg-actions {
        display: flex;
        gap: 6px;
        margin-top: 4px;
      }
      .msg-actions button {
        padding: 4px 8px;
        font-size: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: #4caf50;
        color: #fff;
      }
      .download-dropdown {
        position: relative;
        display: inline-block;
      }
      .download-dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 120px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 5px;
        padding: 5px 0;
        top: 100%;
        left: 0;
      }
      .download-dropdown-content button {
        color: black;
        padding: 8px 16px;
        text-decoration: none;
        display: block;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }
      .download-dropdown-content button:hover {
        background-color: #f1f1f1;
      }
      .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 5px;
        justify-content: flex-end;
      }
      .edit-actions button {
        padding: 6px 12px;
        font-size: 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .edit-actions .save {
        background: #4caf50;
        color: white;
      }
      .edit-actions .cancel {
        background: #f44336;
        color: white;
      }
      .edit-textarea {
        width: 100%;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1.1rem;
        box-sizing: border-box;
        resize: vertical;
        min-height: 50px;
      }
      #file-info-bar {
        background-color: #f0f8ff;
        padding: 10px 20px;
        border-top: 1px solid #ddd;
        display: none;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
        color: #333;
      }
      #file-info-bar button {
        background: none;
        border: none;
        font-weight: bold;
        color: #ff4d4d;
        cursor: pointer;
      }
      .file-sent-banner {
        background-color: #5d3fd3;
        color: #fff;
        padding: 6px 12px;
        font-size: 16px;
        border-radius: 6px;
        margin-bottom: 5px;
        align-self: flex-end;
      }
      #input-container {
        display: flex;
        padding: 20px;
        gap: 8px;
        border-top: 2px solid #4caf50;
        background: #fff;
        align-items: center;
        position: relative;
      }
      body.dark-mode #input-container {
        background: #333;
        border-top: 2px solid #2e7d32;
      }
      #input-container input {
        flex: 1;
        padding: 16px 20px;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
        font-size: 1.1rem;
      }
      #input-container button {
        padding: 14px 24px;
        border-radius: 25px;
        border: none;
        background: #4caf50;
        color: white;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
        flex-shrink: 0;
      }
      #input-container button#add-btn {
        background: none;
        font-size: 2.5rem;
        color: #4caf50;
        padding: 0 10px;
        font-weight: normal;
        border: 2px solid #4caf50;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #input-container button#add-btn:hover {
        background: #e6e6e6;
      }
      #file-menu-dropdown {
        position: absolute;
        bottom: 70px;
        left: 20px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
        flex-direction: column;
        gap: 5px;
        padding: 10px;
      }
      #file-menu-dropdown button {
        background: #f0f0f0;
        color: #333;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: normal;
        width: 100%;
        text-align: left;
      }
      #file-menu-dropdown button:hover {
        background: #e0e0e0;
      }
      #pinned-column {
        width: 260px;
        background: rgba(224, 255, 224, 0.8);
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 10px;
        overflow-y: auto;
        border-left: 2px solid #4caf50;
        display: none;
      }
      body.dark-mode #pinned-column {
        background: #222;
        border-left: 2px solid #2e7d32;
      }
      .pinned-btn {
        padding: 10px;
        border-radius: 18px;
        background: #4caf50;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        text-align: left;
      }
      .pinned-btn:hover {
        background: #66bb6a;
      }
      .divider {
        border-top: 2px solid #4caf50;
        margin: 10px 0;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .typing-indicator-wrapper {
        display: flex;
        align-self: flex-start;
        flex-direction: column;
        gap: 4px;
        margin-top: 5px;
      }
      .typing-indicator {
        display: flex;
        gap: 4px;
        margin-top: 5px;
        padding: 16px 20px;
        background-color: #e0e0e0;
        border-radius: 18px;
        max-width: 70%;
        align-items: center;
      }
      .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #4caf50;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      #ask-button {
        position: absolute;
        display: none;
        padding: 8px 12px;
        border-radius: 25px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 10;
        transform: translateY(-50%);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: relative;
      }
      .modal-content.dark-mode {
        background-color: #333;
        color: #fff;
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .modal-content.dark-mode .close-button:hover,
      .modal-content.dark-mode .close-button:focus {
        color: white;
      }
      #mermaid-container {
        height: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #pinned-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      #pinned-header h3 {
        margin: 0;
      }
      .highlight-message {
        animation: highlight 2s ease-in-out;
      }
      @keyframes highlight {
        0% {
          background-color: rgba(255, 255, 0, 0.5);
        }
        100% {
          background-color: transparent;
        }
      }
    </style>
  </head>
  <body>
    <div id="chat-wrapper">
      <div id="sidebar"></div>
      <div id="chat-area">
        <div id="chat-header">
          <div class="chatbot-profile">
            <span>Genesis</span>
          </div>
          <div>
            <button onclick="clearCurrentChat()">
              🗑 Apagar todas as mensagens desse chat
            </button>
          </div>
        </div>
        <div class="divider"></div>
        <div id="search-container">
          <input
            type="text"
            id="search-input"
            placeholder="Pesquisar no chat..."
            oninput="searchMessages()"
          />
        </div>
        <div class="divider"></div>
        <div id="messages"></div>
        <div class="divider"></div>
        <div id="file-info-bar">
          <span>Documento: </span>
          <span id="file-name"></span>
          <button onclick="clearFileSelection()">x</button>
        </div>
        <div id="input-container">
          <div id="input-actions">
            <button id="add-btn">+</button>
            <input
              type="file"
              id="upload-file"
              accept=".txt,.pdf,.doc,.docx"
              onchange="handleFileUpload(event)"
              style="display: none"
            />
          </div>
          <input
            type="text"
            id="user-input"
            placeholder="Digite sua mensagem..."
          />
          <button id="send-btn">Enviar</button>
          <div id="file-menu-dropdown">
            <button id="btn-pdf">PDF</button>
            <button id="btn-word">Word</button>
            <button id="btn-txt">TXT</button>
          </div>
        </div>
      </div>
      <div id="pinned-column">
        <div id="pinned-header">
          <h3>Fixados</h3>
          <select id="pinned-filter" onchange="filterPinned()">
            <option value="all">Todos</option>
            <option value="bot">Chatbot</option>
            <option value="user">Usuário</option>
          </select>
        </div>
        <div id="pinned-list"></div>
      </div>
    </div>
    <button id="ask-button">Perguntar ao Chat</button>

    <div id="map-modal" class="modal">
      <div id="map-modal-content" class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2>Mapa de Ideias</h2>
        <div id="mermaid-container"></div>
      </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      const messages = document.getElementById("messages");
      const sidebar = document.getElementById("sidebar");
      const pinnedColumn = document.getElementById("pinned-column");
      const pinnedList = document.getElementById("pinned-list");
      const pinnedFilter = document.getElementById("pinned-filter");
      const searchInput = document.getElementById("search-input");
      const userInput = document.getElementById("user-input");
      const askButton = document.getElementById("ask-button");
      const mapModal = document.getElementById("map-modal");
      const mermaidContainer = document.getElementById("mermaid-container");
      const modalContent = document.getElementById("map-modal-content");
      const addBtn = document.getElementById("add-btn");
      const uploadFile = document.getElementById("upload-file");
      const fileMenuDropdown = document.getElementById("file-menu-dropdown");
      const fileInfoBar = document.getElementById("file-info-bar");
      const fileNameSpan = document.getElementById("file-name");
      const btnPdf = document.getElementById("btn-pdf");
      const btnWord = document.getElementById("btn-word");
      const btnTxt = document.getElementById("btn-txt");
      let chats = [],
        currentChat = -1;
      let uploadedFile = null;
      let activeRequests = new Map();
      let isEditing = false;
      let originalMessageId = null;

      // REMOVIDO: const imageSearchInput = document.getElementById("image-search-input");
      // REMOVIDO: const imageResults = document.getElementById("image-results");

      // REMOVIDO: Função performImageSearch
      // REMOVIDO: imageSearchInput.addEventListener

      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        securityLevel: "loose",
      });

      function saveChats() {
        try {
          localStorage.setItem("chats", JSON.stringify(chats));
        } catch (e) {
          console.error("Failed to save chats to localStorage.", e);
        }
      }

      function loadChats() {
        let storedChats;
        try {
          storedChats = JSON.parse(localStorage.getItem("chats"));
          if (!storedChats || !Array.isArray(storedChats)) {
            throw new Error("Invalid chat data in localStorage");
          }
        } catch (e) {
          console.error(
            "Failed to parse chats from localStorage, resetting data."
          );
          storedChats = null;
        }

        if (storedChats && storedChats.length > 0) {
          chats = storedChats;
          currentChat = 0;
        } else {
          chats = [{ name: `Chat 1`, messages: [], isTyping: false }];
          currentChat = 0;
          saveChats();
        }
        renderSidebar();
        renderCurrentChat();
      }

      function newChat() {
        chats.push({
          name: `Chat ${chats.length + 1}`,
          messages: [],
          isTyping: false,
        });
        currentChat = chats.length - 1;
        renderSidebar();
        renderCurrentChat();
        saveChats();
      }

      function clearAllChats() {
        if (
          confirm(
            "Tem certeza que deseja apagar todos os chats e começar do zero?"
          )
        ) {
          chats = [{ name: `Chat 1`, messages: [], isTyping: false }];
          currentChat = 0;
          saveChats();
          renderSidebar();
          renderCurrentChat();
        }
      }

      function switchChat(index) {
        if (index < 0 || index >= chats.length) return;
        currentChat = index;
        renderSidebar();
        renderCurrentChat();
        saveChats();
      }

      function renderCurrentChat() {
        messages.innerHTML = "";
        chats[currentChat].messages.forEach((m) => {
          messages.appendChild(createMessageElement(m));
        });

        if (chats[currentChat].isTyping) {
          const typingWrapper = document.createElement("div");
          typingWrapper.className = "typing-indicator-wrapper";

          const typingIndicator = document.createElement("div");
          typingIndicator.className = "typing-indicator";
          typingIndicator.innerHTML = "<span></span><span></span><span></span>";
          typingWrapper.appendChild(typingIndicator);

          messages.appendChild(typingWrapper);
        }

        messages.scrollTop = messages.scrollHeight;
      }

      function renameChat(index) {
        const newName = prompt(
          "Digite o novo nome do chat:",
          chats[index].name
        );
        if (newName && newName.trim() !== "") {
          chats[index].name = newName.trim();
          renderSidebar();
          saveChats();
        }
      }

      function deleteChat(index) {
        if (
          confirm(
            `Tem certeza de que deseja apagar o chat "${chats[index].name}"?`
          )
        ) {
          chats.splice(index, 1);
          if (chats.length === 0) {
            newChat();
          } else {
            currentChat = Math.max(0, currentChat - 1);
            switchChat(currentChat);
          }
          saveChats();
          updatePinnedColumn();
        }
      }

      function renderSidebar() {
        sidebar.innerHTML = "";

        const pinnedBtn = document.createElement("div");
        pinnedBtn.className = "sidebar-btn";
        pinnedBtn.innerHTML = `<span>⭐ Fixados</span>`;
        pinnedBtn.onclick = togglePinnedColumn;
        sidebar.appendChild(pinnedBtn);

        chats.forEach((c, i) => {
          const btn = document.createElement("div");
          btn.className = "sidebar-btn" + (i === currentChat ? " active" : "");
          btn.innerHTML = `
            <span>${c.name}</span>
            <div class="sidebar-btn-options" onclick="event.stopPropagation(); showChatMenu(event, ${i})">...</div>
            <div id="chat-menu-${i}" class="chat-menu">
              <button onclick="renameChat(${i})">Renomear</button>
              <button onclick="deleteChat(${i})">Apagar</button>
            </div>
          `;
          btn.onclick = () => {
            switchChat(i);
            pinnedColumn.style.display = "none";
          };
          sidebar.appendChild(btn);
        });

        const newBtn = document.createElement("div");
        newBtn.className = "sidebar-btn";
        newBtn.textContent = "+ Novo Chat";
        newBtn.onclick = newChat;
        sidebar.appendChild(newBtn);

        const resetBtn = document.createElement("div");
        resetBtn.className = "sidebar-btn";
        resetBtn.textContent = "Apagar Tudo";
        resetBtn.style.backgroundColor = "#f44336";
        resetBtn.style.color = "#fff";
        resetBtn.onclick = clearAllChats;
        sidebar.appendChild(resetBtn);
      }

      function togglePinnedColumn() {
        const isVisible = pinnedColumn.style.display === "flex";
        pinnedColumn.style.display = isVisible ? "none" : "flex";
        if (!isVisible) {
          updatePinnedColumn();
        }
      }

      function showChatMenu(event, index) {
        document.querySelectorAll(".chat-menu").forEach((menu) => {
          menu.style.display = "none";
        });
        const menu = document.getElementById(`chat-menu-${index}`);
        menu.style.display = "flex";
      }

      document.addEventListener("click", function (event) {
        document.querySelectorAll(".chat-menu").forEach((menu) => {
          if (!menu.contains(event.target)) {
            menu.style.display = "none";
          }
        });
      });

      function downloadSingleMessage(text, type) {
        if (type === "pdf") {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text(text, 10, 10);
          doc.save("mensagem.pdf");
        } else if (type === "word") {
          const blob = new Blob([text], {
            type: "application/msword",
          });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "mensagem.doc";
          link.click();
        }
      }

      function createMessageElement(messageData) {
        const { text, sender, pinned, fileName, id, chatIndex } = messageData;

        const wrapper = document.createElement("div");
        wrapper.className = "message-wrapper";
        wrapper.setAttribute("data-id", id);

        if (fileName) {
          const fileBanner = document.createElement("div");
          fileBanner.className = "file-sent-banner";
          fileBanner.innerText = `Documento: ${fileName}`;
          wrapper.appendChild(fileBanner);
        }

        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + sender;
        if (pinned) msgDiv.classList.add("pinned");
        msgDiv.innerText = text;
        wrapper.appendChild(msgDiv);

        if (text) {
          const actions = document.createElement("div");
          actions.className = "msg-actions";
          actions.style.justifyContent =
            sender === "user" ? "flex-end" : "flex-start";

          if (sender === "bot") {
            const editBtn = document.createElement("button");
            editBtn.innerText = "Editar";
            editBtn.onclick = () => startEdit(id);
            actions.appendChild(editBtn);

            const summarizeBtn = document.createElement("button");
            summarizeBtn.innerText = "Resumir";
            summarizeBtn.onclick = async () => {
              const newId = Date.now();
              addMessageToChat({ text: "", sender: "bot" }, currentChat);
              chats[currentChat].isTyping = true;
              renderCurrentChat();
              try {
                const promptText = `Por favor, resuma o seguinte texto de forma concisa:\n\n"${text}"`;
                const response = await puter.ai.chat(promptText, {
                  model: "gpt-5-nano",
                });
                handleIncomingResponse(response, newId);
              } catch (e) {
                handleIncomingResponse(
                  "Não foi possível gerar o resumo. Por favor, tente novamente mais tarde.",
                  newId,
                  true
                );
              }
            };
            actions.appendChild(summarizeBtn);

            const downloadDropdown = document.createElement("div");
            downloadDropdown.className = "download-dropdown";
            const downloadBtn = document.createElement("button");
            downloadBtn.innerText = "Download";
            downloadBtn.onclick = (e) => {
              e.stopPropagation();
              const dropdownContent = downloadBtn.nextElementSibling;
              dropdownContent.style.display =
                dropdownContent.style.display === "block" ? "none" : "block";
            };
            const dropdownContent = document.createElement("div");
            dropdownContent.className = "download-dropdown-content";
            const pdfBtn = document.createElement("button");
            pdfBtn.innerText = "PDF";
            pdfBtn.onclick = (e) => {
              e.stopPropagation();
              downloadSingleMessage(text, "pdf");
              dropdownContent.style.display = "none";
            };
            const wordBtn = document.createElement("button");
            wordBtn.innerText = "Word";
            wordBtn.onclick = (e) => {
              e.stopPropagation();
              downloadSingleMessage(text, "word");
              dropdownContent.style.display = "none";
            };
            dropdownContent.appendChild(pdfBtn);
            dropdownContent.appendChild(wordBtn);
            downloadDropdown.appendChild(downloadBtn);
            downloadDropdown.appendChild(dropdownContent);
            actions.appendChild(downloadDropdown);
          }

          const pinBtn = document.createElement("button");
          pinBtn.innerText = pinned ? "Desafixar" : "Fixar";
          pinBtn.onclick = () => {
            const m = chats[currentChat].messages.find((m) => m.id === id);
            if (m) {
              m.pinned = !m.pinned;
              saveChats();
              renderCurrentChat();
              updatePinnedColumn();
            }
          };
          const delBtn = document.createElement("button");
          delBtn.innerText = "Apagar";
          delBtn.onclick = () => {
            deleteMessage(id);
          };

          actions.appendChild(pinBtn);
          actions.appendChild(delBtn);

          wrapper.appendChild(actions);
        }

        return wrapper;
      }

      function addMessageToChat(messageData, chatIndex, aiRequestId = null) {
        const newMessage = {
          id: Date.now(),
          aiRequestId,
          ...messageData,
        };
        chats[chatIndex].messages.push(newMessage);
        saveChats();

        if (chatIndex === currentChat) {
          renderCurrentChat();
        }
        return newMessage;
      }

      function generateMermaidSyntaxFromJSON(jsonData) {
        if (!jsonData || !jsonData.nodes || !jsonData.links) {
          return null;
        }

        let mermaidSyntax = "graph TD\n";
        const nodeMap = new Map();
        jsonData.nodes.forEach((node, index) => {
          const safeNodeId = node.replace(/[^a-zA-Z0-9]/g, "_");
          nodeMap.set(node, `N${index}(["${node}"])`);
        });

        jsonData.links.forEach((link) => {
          const source = link[0];
          const target = link[1];
          if (nodeMap.has(source) && nodeMap.has(target)) {
            mermaidSyntax += `    ${nodeMap.get(source).split('(["')[0]} --> ${
              nodeMap.get(target).split('(["')[0]
            }\n`;
          }
        });

        let uniqueNodesSyntax = "";
        nodeMap.forEach((value) => {
          uniqueNodesSyntax += `    ${value}\n`;
        });

        return mermaidSyntax + uniqueNodesSyntax;
      }

      function showMapModal(aiResponse) {
        if (typeof aiResponse !== "string") {
          alert(
            "Não foi possível gerar o mapa. A IA retornou um formato de dados inesperado. Por favor, tente mapear uma mensagem diferente."
          );
          return;
        }

        try {
          const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
          if (!jsonMatch) {
            throw new Error("Conteúdo JSON não encontrado na resposta.");
          }
          const jsonString = jsonMatch[0];

          const jsonData = JSON.parse(jsonString);
          const mermaidSyntax = generateMermaidSyntaxFromJSON(jsonData);

          if (!mermaidSyntax) {
            throw new Error("Formato JSON inválido ou incompleto.");
          }

          mermaidContainer.innerHTML = `<pre class="mermaid">${mermaidSyntax}</pre>`;
          mapModal.style.display = "block";
          mermaid.init(undefined, mermaidContainer);
        } catch (e) {
          console.error("Erro ao gerar mapa:", e);
          const errorMessage = `Não foi possível gerar o mapa. A IA retornou um formato de dados inesperado. Por favor, tente mapear uma mensagem diferente. Detalhes: ${e.message}`;
          alert(errorMessage);
        }
      }

      function closeModal() {
        mapModal.style.display = "none";
        mermaidContainer.innerHTML = "";
      }

      window.onclick = function (event) {
        if (event.target == mapModal) {
          closeModal();
        }
      };

      function updatePinnedColumn() {
        const filterValue = pinnedFilter.value;
        pinnedList.innerHTML = "";

        const allPinned = [];
        chats.forEach((chat, chatIndex) => {
          chat.messages.forEach((msg) => {
            if (msg.pinned) {
              allPinned.push({
                ...msg,
                chatIndex: chatIndex,
                chatName: chat.name,
              });
            }
          });
        });

        const filteredPinned = allPinned.filter(
          (m) => filterValue === "all" || m.sender === filterValue
        );

        if (filteredPinned.length === 0) {
          pinnedList.innerHTML = `<p style="color:#666;text-align:center;padding:20px;">Nenhuma mensagem fixada.</p>`;
          return;
        }

        filteredPinned.forEach((m) => {
          const btn = document.createElement("div");
          btn.className = "pinned-btn";
          btn.innerHTML = `**${m.chatName} (${m.sender})**<br>${m.text.slice(
            0,
            50
          )}...`;
          btn.onclick = () => goToPinnedMessage(m.chatIndex, m.id);
          pinnedList.appendChild(btn);
        });
      }

      function filterPinned() {
        updatePinnedColumn();
      }

      function goToPinnedMessage(chatIndex, messageId) {
        switchChat(chatIndex);
        setTimeout(() => {
          const msgDiv = document.querySelector(
            `[data-id="${messageId}"] .message`
          );
          if (msgDiv) {
            msgDiv.scrollIntoView({ behavior: "smooth", block: "center" });
            msgDiv.classList.add("highlight-message");
            setTimeout(() => {
              msgDiv.classList.remove("highlight-message");
            }, 2000);
          }
        }, 100);
      }

      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        modalContent.classList.toggle("dark-mode");
      }

      function clearCurrentChat() {
        if (currentChat < 0) return;
        if (confirm("Deseja apagar todas as mensagens do chat?")) {
          messages.innerHTML = "";
          chats[currentChat].messages = [];
          saveChats();
          updatePinnedColumn();
        }
      }

      function searchMessages() {
        const term = searchInput.value.toLowerCase();
        document.querySelectorAll(".message").forEach((msg) => {
          msg.parentElement.style.display = msg.innerText
            .toLowerCase()
            .includes(term)
            ? "flex"
            : "none";
        });
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          uploadedFile = file;
          userInput.value = "Analisar documento";
          fileNameSpan.textContent = uploadedFile.name;
          fileInfoBar.style.display = "flex";
        }
        event.target.value = null;
        fileMenuDropdown.style.display = "none";
      }

      function clearFileSelection() {
        uploadedFile = null;
        userInput.value = "";
        fileNameSpan.textContent = "";
        fileInfoBar.style.display = "none";
      }

      function deleteMessage(messageId) {
        const messageIndex = chats[currentChat].messages.findIndex(
          (m) => m.id === messageId
        );
        if (messageIndex === -1) return;

        const messageToDelete = chats[currentChat].messages[messageIndex];

        if (messageToDelete.sender === "bot") {
          if (
            messageToDelete.aiRequestId &&
            activeRequests.has(messageToDelete.aiRequestId)
          ) {
            activeRequests.get(messageToDelete.aiRequestId).controller.abort();
            activeRequests.delete(messageToDelete.aiRequestId);
          }
          if (
            messageIndex > 0 &&
            chats[currentChat].messages[messageIndex - 1].sender === "user"
          ) {
            chats[currentChat].messages.splice(messageIndex - 1, 2);
          } else {
            chats[currentChat].messages.splice(messageIndex, 1);
          }
        } else {
          const botMessageIndex = messageIndex + 1;
          if (
            botMessageIndex < chats[currentChat].messages.length &&
            chats[currentChat].messages[botMessageIndex].sender === "bot"
          ) {
            const botMessage = chats[currentChat].messages[botMessageIndex];
            if (
              botMessage.aiRequestId &&
              activeRequests.has(botMessage.aiRequestId)
            ) {
              activeRequests.get(botMessage.aiRequestId).controller.abort();
              activeRequests.delete(botMessage.aiRequestId);
            }
            chats[currentChat].messages.splice(messageIndex, 2);
          } else {
            chats[currentChat].messages.splice(messageIndex, 1);
          }
        }

        renderCurrentChat();
        saveChats();
        updatePinnedColumn();
      }

      async function sendMessage(
        text = userInput.value.trim(),
        file = uploadedFile
      ) {
        if (currentChat < 0) newChat();

        if (!text && !file) return;

        for (let [reqId, reqData] of activeRequests.entries()) {
          reqData.controller.abort();
          activeRequests.delete(reqId);
        }
        chats[currentChat].isTyping = false;

        const userMessage = addMessageToChat(
          { text, sender: "user", fileName: file ? file.name : null },
          currentChat
        );

        userInput.value = "";
        clearFileSelection();

        let prompt = text;

        if (file) {
          try {
            const fileReader = new FileReader();
            const fileContent = await new Promise((resolve, reject) => {
              fileReader.onload = (e) => resolve(e.target.result);
              fileReader.onerror = (e) => reject(e);
              fileReader.readAsText(file);
            });
            prompt = `O usuário fez o upload de um arquivo. O conteúdo do arquivo é:\n\n---\n${fileContent}\n---\n\nE a pergunta é: "${text}". Por favor, analise o documento e responda à pergunta.`;
          } catch (e) {
            console.error("Failed to read file:", e);
            const errorMessage =
              "Desculpe, não consegui ler o arquivo. Por favor, tente outro formato ou arquivo.";
            addMessageToChat(
              { text: errorMessage, sender: "bot" },
              currentChat
            );
            return;
          }
        }

        const controller = new AbortController();
        const signal = controller.signal;
        const aiRequestId = Date.now();

        const placeholderMessage = addMessageToChat(
          { text: "", sender: "bot", aiRequestId },
          currentChat
        );
        activeRequests.set(aiRequestId, { controller });

        chats[currentChat].isTyping = true;
        renderCurrentChat();

        try {
          const response = await puter.ai.chat(prompt, {
            model: "gpt-5-nano",
            signal,
          });
          handleIncomingResponse(response, aiRequestId);
        } catch (e) {
          if (e.name === "AbortError") {
            console.log("AI request aborted");
            handleIncomingResponse(null, aiRequestId, false, true);
          } else {
            console.error("AI request failed:", e);
            const errorMessage =
              "Desculpe, o serviço de IA falhou. Por favor, tente novamente.";
            handleIncomingResponse(errorMessage, aiRequestId, true);
          }
        }
      }

      async function handleIncomingResponse(
        text,
        requestId,
        isError = false,
        isAborted = false
      ) {
        const requestData = activeRequests.get(requestId);
        if (isAborted) {
          return;
        }

        activeRequests.delete(requestId);

        let messageToUpdate = chats[currentChat].messages.find(
          (m) => m.aiRequestId === requestId
        );

        if (messageToUpdate) {
          if (isAborted) {
            const userMessageIndex = chats[currentChat].messages.findIndex(
              (m) => m.id === messageToUpdate.id - 1
            );
            if (userMessageIndex !== -1) {
              chats[currentChat].messages.splice(userMessageIndex, 2);
            }
          } else {
            messageToUpdate.text = text;
          }
        }

        chats[currentChat].isTyping = false;
        renderCurrentChat();
        saveChats();
      }

      function startEdit(id) {
        if (isEditing) return;

        isEditing = true;
        originalMessageId = id;

        const messageElement = document.querySelector(
          `.message-wrapper[data-id="${id}"] .message`
        );
        const originalText = messageElement.innerText;

        const textarea = document.createElement("textarea");
        textarea.className = "edit-textarea";
        textarea.value = originalText;

        messageElement.replaceWith(textarea);

        const actionsContainer = document.querySelector(
          `.message-wrapper[data-id="${id}"] .msg-actions`
        );
        actionsContainer.style.display = "none";

        const editActions = document.createElement("div");
        editActions.className = "edit-actions";

        const saveBtn = document.createElement("button");
        saveBtn.innerText = "Salvar";
        saveBtn.className = "save";
        saveBtn.onclick = () => saveEdit(id, textarea.value);

        const cancelBtn = document.createElement("button");
        cancelBtn.innerText = "Cancelar";
        cancelBtn.className = "cancel";
        cancelBtn.onclick = () => cancelEdit(id, originalText);

        editActions.appendChild(saveBtn);
        editActions.appendChild(cancelBtn);

        textarea.after(editActions);

        textarea.focus();
      }

      function saveEdit(id, newText) {
        const messageObject = chats[currentChat].messages.find(
          (m) => m.id === id
        );
        if (messageObject) {
          messageObject.text = newText;
        }

        isEditing = false;
        renderCurrentChat();
        saveChats();
      }

      function cancelEdit(id, originalText) {
        const messageElement = document.querySelector(
          `.message-wrapper[data-id="${id}"] textarea`
        );
        const originalDiv = document.createElement("div");
        originalDiv.className = "message bot";
        originalDiv.innerText = originalText;

        messageElement.replaceWith(originalDiv);

        const editActions = document.querySelector(
          `.message-wrapper[data-id="${id}"] .edit-actions`
        );
        editActions.remove();

        const actionsContainer = document.querySelector(
          `.message-wrapper[data-id="${id}"] .msg-actions`
        );
        actionsContainer.style.display = "flex";

        isEditing = false;
        renderCurrentChat();
      }

      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });
      document
        .getElementById("send-btn")
        .addEventListener("click", sendMessage);
      document.getElementById("add-btn").addEventListener("click", () => {
        const dropdown = document.getElementById("file-menu-dropdown");
        dropdown.style.display =
          dropdown.style.display === "flex" ? "none" : "flex";
      });
      btnPdf.onclick = () => uploadFile.click();
      btnWord.onclick = () => uploadFile.click();
      btnTxt.onclick = () => uploadFile.click();

      const themeToggleBtn = document.createElement("button");
      themeToggleBtn.innerText = "🌙";
      themeToggleBtn.style.cssText =
        "position: fixed; bottom: 20px; right: 20px; font-size: 24px; background: #fff; border-radius: 50%; width: 50px; height: 50px; border: 2px solid #ccc; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1);";
      themeToggleBtn.onclick = toggleTheme;
      document.body.appendChild(themeToggleBtn);

      window.addEventListener("load", loadChats);
    </script>
  </body>
</html>

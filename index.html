<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genesis</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #6e8efb, #a777e3);
        color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      body.dark-mode {
        background: linear-gradient(135deg, #1a1a1a, #333);
        color: #fff;
      }
      .form-container {
        background: #fff;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        width: 400px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        border: 5px solid #4caf50;
        text-align: center;
      }
      body.dark-mode .form-container {
        background: #1e1e1e;
        border: 5px solid #2e7d32;
      }
      .form-container h2 {
        color: #4caf50;
        font-size: 2em;
        margin-bottom: 10px;
      }
      .form-container p {
        color: #555;
      }
      .form-container input {
        width: 100%;
        padding: 15px;
        border-radius: 15px;
        border: 1px solid #ddd;
        font-size: 1rem;
        box-sizing: border-box;
      }
      .form-container button {
        padding: 15px;
        border-radius: 15px;
        border: none;
        background: #4caf50;
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }
      .form-container button:hover {
        background: #66bb6a;
      }
      .form-toggle {
        font-size: 0.9em;
        color: #007bff;
        cursor: pointer;
        margin-top: 10px;
      }
      #chat-wrapper {
        width: 1200px;
        height: 650px;
        margin: 20px auto;
        display: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        background: #fff;
        border: 5px solid #4caf50;
      }
      body.dark-mode #chat-wrapper {
        background: #1e1e1e;
        border: 5px solid #2e7d32;
      }
      #sidebar {
        width: 260px;
        background: rgba(224, 255, 224, 0.8);
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 10px;
        overflow-y: auto;
        border-right: 2px solid #4caf50;
      }
      body.dark-mode #sidebar {
        background: #222;
        border-right: 2px solid #2e7d32;
      }
      .sidebar-btn {
        padding: 12px;
        border-radius: 18px;
        background: #ccc;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s;
        position: relative;
      }
      .sidebar-btn.active {
        background: #4caf50;
        color: #fff;
        font-weight: bold;
        border: 2px solid #2e7d32;
      }
      .sidebar-btn:hover {
        background: #66bb6a;
      }
      .sidebar-btn-options {
        cursor: pointer;
        font-weight: bold;
        padding: 0 5px;
      }
      .chat-menu {
        position: absolute;
        top: 40px;
        right: 10px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 10;
        display: none;
        flex-direction: column;
      }
      .chat-menu button {
        background: none;
        border: none;
        padding: 10px;
        cursor: pointer;
        text-align: left;
        color: #333;
        font-size: 14px;
      }
      .chat-menu button:hover {
        background: #f0f0f0;
      }
      #chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        background: #f9f9f9;
      }
      body.dark-mode #chat-area {
        background: #222;
      }
      #chat-header {
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #4caf50;
        color: white;
      }
      #chat-header button,
      #chat-header input[type="file"] {
        padding: 6px 12px;
        border: none;
        border-radius: 25px;
        background: #66bb6a;
        color: white;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .chatbot-profile {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .chatbot-profile span {
        font-weight: bold;
        font-size: 1.2rem;
      }
      #download-buttons {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      #download-buttons button {
        white-space: nowrap;
      }
      #search-container {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
      }
      #search-container input {
        padding: 16px 20px;
        font-size: 1.1rem;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
        width: calc(100% - 40px);
        margin: 0 auto;
        display: block;
      }
      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .message-wrapper {
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease;
        position: relative;
      }
      .message {
        padding: 16px 20px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        line-height: 1.4;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .message.user {
        background: #dcf8c6;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
      }
      .message.bot {
        background: #ffffff;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
      }
      .message.pinned {
        border: 2px solid gold;
      }
      .message img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
      }
      .msg-actions {
        display: flex;
        gap: 6px;
        margin-top: 4px;
      }
      .msg-actions button {
        padding: 4px 8px;
        font-size: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: #4caf50;
        color: #fff;
      }
      .download-dropdown {
        position: relative;
        display: inline-block;
      }
      .download-dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 120px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 5px;
        padding: 5px 0;
        top: 100%;
        left: 0;
      }
      .download-dropdown-content button {
        color: black;
        padding: 8px 16px;
        text-decoration: none;
        display: block;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }
      .download-dropdown-content button:hover {
        background-color: #f1f1f1;
      }
      .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 5px;
        justify-content: flex-end;
      }
      .edit-actions button {
        padding: 6px 12px;
        font-size: 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .edit-actions .save {
        background: #4caf50;
        color: white;
      }
      .edit-actions .cancel {
        background: #f44336;
        color: white;
      }
      .edit-textarea {
        width: 100%;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1.1rem;
        box-sizing: border-box;
        resize: vertical;
        min-height: 50px;
      }
      #file-info-bar {
        background-color: #f0f8ff;
        padding: 10px 20px;
        border-top: 1px solid #ddd;
        display: none;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
        color: #333;
      }
      #file-info-bar button {
        background: none;
        border: none;
        font-weight: bold;
        color: #ff4d4d;
        cursor: pointer;
      }
      .file-sent-banner {
        background-color: #5d3fd3;
        color: #fff;
        padding: 6px 12px;
        font-size: 16px;
        border-radius: 6px;
        margin-bottom: 5px;
        align-self: flex-end;
      }
      #input-container {
        display: flex;
        padding: 20px;
        gap: 8px;
        border-top: 2px solid #4caf50;
        background: #fff;
        align-items: center;
        position: relative;
      }
      body.dark-mode #input-container {
        background: #333;
        border-top: 2px solid #2e7d32;
      }
      #input-container input {
        flex: 1;
        padding: 16px 20px;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
        font-size: 1.1rem;
      }
      #input-container button {
        padding: 14px 24px;
        border-radius: 25px;
        border: none;
        background: #4caf50;
        color: white;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
        flex-shrink: 0;
      }
      #input-container button#add-btn {
        background: none;
        font-size: 2.5rem;
        color: #4caf50;
        padding: 0 10px;
        font-weight: normal;
        border: 2px solid #4caf50;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #input-container button#add-btn:hover {
        background: #e6e6e6;
      }
      #file-menu-dropdown {
        position: absolute;
        bottom: 70px;
        left: 20px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
        flex-direction: column;
        gap: 5px;
        padding: 10px;
      }
      #file-menu-dropdown button {
        background: #f0f0f0;
        color: #333;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: normal;
        width: 100%;
        text-align: left;
      }
      #file-menu-dropdown button:hover {
        background: #e0e0e0;
      }
      #pinned-column {
        width: 260px;
        background: rgba(224, 255, 224, 0.8);
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 10px;
        overflow-y: auto;
        border-left: 2px solid #4caf50;
        display: none;
      }
      body.dark-mode #pinned-column {
        background: #222;
        border-left: 2px solid #2e7d32;
      }
      .pinned-btn {
        padding: 10px;
        border-radius: 18px;
        background: #4caf50;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        text-align: left;
      }
      .pinned-btn:hover {
        background: #66bb6a;
      }
      .divider {
        border-top: 2px solid #4caf50;
        margin: 10px 0;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .typing-indicator-wrapper {
        display: flex;
        align-self: flex-start;
        flex-direction: column;
        gap: 4px;
        margin-top: 5px;
      }
      .typing-indicator {
        display: flex;
        gap: 4px;
        margin-top: 5px;
        padding: 16px 20px;
        background-color: #e0e0e0;
        border-radius: 18px;
        max-width: 70%;
        align-items: center;
      }
      .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #4caf50;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      #ask-button {
        position: absolute;
        display: none;
        padding: 8px 12px;
        border-radius: 25px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 10;
        transform: translateY(-50%);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: relative;
      }
      .modal-content.dark-mode {
        background-color: #333;
        color: #fff;
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .modal-content.dark-mode .close-button:hover,
      .modal-content.dark-mode .close-button:focus {
        color: white;
      }
      #mermaid-container {
        height: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #pinned-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      #pinned-header h3 {
        margin: 0;
      }
      .highlight-message {
        animation: highlight 2s ease-in-out;
      }
      @keyframes highlight {
        0% {
          background-color: rgba(255, 255, 0, 0.5);
        }
        100% {
          background-color: transparent;
        }
      }
      #user-profile-modal-content {
        text-align: left;
      }
      #user-profile-modal-content h3 {
        color: #4caf50;
        margin-top: 0;
      }
      #user-profile-modal-content p {
        font-size: 1.1em;
        margin: 10px 0;
      }
      .modal-button-group {
        display: flex;
        flex-direction: row;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      .modal-button-group button {
        padding: 12px 20px;
        border-radius: 18px;
        background: #4caf50;
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background 0.3s;
      }
      .modal-button-group button:hover {
        background: #66bb6a;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="login-form" class="form-container">
      <h2>Bem-vindo!</h2>
      <p>Por favor, entre ou crie sua conta.</p>
      <input type="email" id="login-email" placeholder="Seu e-mail" required />
      <input
        type="password"
        id="login-password"
        placeholder="Sua senha"
        required
      />
      <button onclick="handleLogin()">Entrar</button>
      <div class="form-toggle" onclick="toggleForm('register')">
        Não tem uma conta? Cadastre-se
      </div>
    </div>

    <div id="register-form" class="form-container hidden">
      <h2>Bem-vindo ao Genesis</h2>
      <p>Preencha seus dados para continuar.</p>
      <input
        type="text"
        id="register-username"
        placeholder="Nome de usuário"
        required
      />
      <input
        type="email"
        id="register-email"
        placeholder="Seu e-mail"
        required
      />
      <input
        type="password"
        id="register-password"
        placeholder="Crie sua senha"
        required
      />
      <input type="date" id="register-dob" required />
      <button onclick="handleRegister()">Cadastrar</button>
      <div class="form-toggle" onclick="toggleForm('login')">
        Já tem uma conta? Entrar
      </div>
    </div>

    <div id="chat-wrapper" class="hidden">
      <div id="sidebar"></div>
      <div id="chat-area">
        <div id="chat-header">
          <div class="chatbot-profile">
            <span>Genesis</span>
          </div>
          <div>
            <button onclick="clearCurrentChat()">
              🗑 Apagar todas as mensagens desse chat
            </button>
          </div>
        </div>
        <div class="divider"></div>
        <div id="search-container">
          <input
            type="text"
            id="search-input"
            placeholder="Pesquisar no chat..."
            oninput="searchMessages()"
          />
        </div>
        <div class="divider"></div>
        <div id="messages"></div>
        <div class="divider"></div>
        <div id="file-info-bar">
          <span>Documento: </span>
          <span id="file-name"></span>
          <button onclick="clearFileSelection()">x</button>
        </div>
        <div id="input-container">
          <div id="input-actions">
            <button id="add-btn">+</button>
            <input
              type="file"
              id="upload-file"
              accept=".txt,.pdf,.doc,.docx"
              onchange="handleFileUpload(event)"
              style="display: none"
            />
          </div>
          <input
            type="text"
            id="user-input"
            placeholder="Digite sua mensagem..."
          />
          <button id="send-btn">Enviar</button>
          <div id="file-menu-dropdown">
            <button id="btn-pdf">PDF</button>
            <button id="btn-word">Word</button>
            <button id="btn-txt">TXT</button>
          </div>
        </div>
      </div>
      <div id="pinned-column">
        <div id="pinned-header">
          <h3>Fixados</h3>
          <select id="pinned-filter" onchange="filterPinned()">
            <option value="all">Todos</option>
            <option value="bot">Chatbot</option>
            <option value="user">Usuário</option>
          </select>
        </div>
        <div id="pinned-list"></div>
      </div>
    </div>
    <button id="ask-button">Perguntar ao Chat</button>

    <div id="map-modal" class="modal">
      <div id="map-modal-content" class="modal-content">
        <span class="close-button" onclick="closeModal('map-modal')"
          >&times;</span
        >
        <h2>Mapa de Ideias</h2>
        <div id="mermaid-container"></div>
      </div>
    </div>

    <div id="user-profile-modal" class="modal">
      <div id="user-profile-modal-content" class="modal-content">
        <span class="close-button" onclick="closeModal('user-profile-modal')"
          >&times;</span
        >
        <h2>Perfil de Usuário</h2>
        <div class="modal-button-group">
          <button onclick="showUserData()">Ver Dados</button>
          <button onclick="logout()">Sair da Conta</button>
        </div>
        <div id="user-info" class="hidden" style="margin-top: 20px">
          <p><strong>Nome:</strong> <span id="profile-name"></span></p>
          <p><strong>E-mail:</strong> <span id="profile-email"></span></p>
          <p><strong>Senha:</strong> <span id="profile-password"></span></p>
          <p>
            <strong>Data de Nascimento:</strong> <span id="profile-dob"></span>
          </p>
        </div>
      </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      const messages = document.getElementById("messages");
      const sidebar = document.getElementById("sidebar");
      const pinnedColumn = document.getElementById("pinned-column");
      const pinnedList = document.getElementById("pinned-list");
      const pinnedFilter = document.getElementById("pinned-filter");
      const searchInput = document.getElementById("search-input");
      const userInput = document.getElementById("user-input");
      const askButton = document.getElementById("ask-button");
      const mapModal = document.getElementById("map-modal");
      const mermaidContainer = document.getElementById("mermaid-container");
      const modalContent = document.getElementById("map-modal-content");
      const addBtn = document.getElementById("add-btn");
      const uploadFile = document.getElementById("upload-file");
      const fileMenuDropdown = document.getElementById("file-menu-dropdown");
      const fileInfoBar = document.getElementById("file-info-bar");
      const fileNameSpan = document.getElementById("file-name");

      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const chatWrapper = document.getElementById("chat-wrapper");
      const userProfileModal = document.getElementById("user-profile-modal");
      const profileName = document.getElementById("profile-name");
      const profileEmail = document.getElementById("profile-email");
      const profilePassword = document.getElementById("profile-password");
      const profileDob = document.getElementById("profile-dob");
      const userInfoDiv = document.getElementById("user-info");

      const GIPHY_API_KEY = "eLIbdvWpV2XcSqhAIEYS5Bf7E47lLaRG";
      let chats = [],
        currentChat = -1;
      let uploadedFile = null;
      let activeRequests = new Map();
      let isEditing = false;
      let originalMessageId = null;
      let userData = null;

      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        securityLevel: "loose",
      });

      window.onload = function () {
        const storedUser = localStorage.getItem("userData");
        if (storedUser) {
          userData = JSON.parse(storedUser);
          startChatSession();
        } else {
          toggleForm("login");
        }
      };

      function toggleForm(formId) {
        loginForm.classList.add("hidden");
        registerForm.classList.add("hidden");
        document.getElementById(formId + "-form").classList.remove("hidden");
      }

      function handleLogin() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const storedUser = localStorage.getItem("userData");
        if (storedUser) {
          const user = JSON.parse(storedUser);
          if (user.email === email && user.password === password) {
            userData = user;
            startChatSession();
          } else {
            alert("E-mail ou senha incorretos.");
          }
        } else {
          alert("Nenhum usuário encontrado. Por favor, cadastre-se primeiro.");
        }
      }

      function handleRegister() {
        const username = document.getElementById("register-username").value;
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const dob = document.getElementById("register-dob").value;
        if (username && email && password && dob) {
          userData = { username, email, password, dob };
          localStorage.setItem("userData", JSON.stringify(userData));
          startChatSession();
        } else {
          alert("Por favor, preencha todos os campos.");
        }
      }

      function startChatSession() {
        loginForm.classList.add("hidden");
        registerForm.classList.add("hidden");
        chatWrapper.classList.remove("hidden");
        chatWrapper.style.display = "flex";
        loadChats();
      }

      function showUserProfile() {
        if (userData) {
          userProfileModal.style.display = "block";
          userInfoDiv.classList.add("hidden");
        }
      }

      function showUserData() {
        if (userData) {
          profileName.textContent = userData.username;
          profileEmail.textContent = userData.email;
          profilePassword.textContent = "•".repeat(userData.password.length);
          profileDob.textContent = userData.dob;
          userInfoDiv.classList.remove("hidden");
        }
      }

      function logout() {
        if (confirm("Tem certeza que deseja sair da sua conta?")) {
          localStorage.removeItem("userData");
          userData = null;
          chatWrapper.classList.add("hidden");
          toggleForm("login");
          closeModal("user-profile-modal");
        }
      }

      function saveChats() {
        try {
          localStorage.setItem("chats", JSON.stringify(chats));
        } catch (e) {
          console.error("Failed to save chats to localStorage.", e);
        }
      }

      function loadChats() {
        let storedChats;
        try {
          storedChats = JSON.parse(localStorage.getItem("chats"));
          if (!storedChats || !Array.isArray(storedChats)) {
            throw new Error("Invalid chat data in localStorage");
          }
        } catch (e) {
          console.error(
            "Failed to parse chats from localStorage, resetting data."
          );
          storedChats = null;
        }

        if (storedChats && storedChats.length > 0) {
          chats = storedChats;
          currentChat = 0;
        } else {
          chats = [{ name: `Chat 1`, messages: [], isTyping: false }];
          currentChat = 0;
          saveChats();
        }

        renderSidebar();
        renderCurrentChat();
      }

      function newChat() {
        chats.push({ name: `Chat ${chats.length + 1}`, messages: [], isTyping: false });
        currentChat = chats.length - 1;
        renderSidebar();
        renderCurrentChat();
        saveChats();
      }

      function clearCurrentChat() {
        if (
          confirm(
            "Tem certeza que deseja apagar todas as mensagens deste chat?"
          )
        ) {
          chats[currentChat].messages = [];
          saveChats();
          renderCurrentChat();
        }
      }

      function clearAllChats() {
        if (
          confirm(
            "Tem certeza que deseja apagar todos os chats e começar do zero?"
          )
        ) {
          chats = [{ name: `Chat 1`, messages: [], isTyping: false }];
          currentChat = 0;
          saveChats();
          renderSidebar();
          renderCurrentChat();
        }
      }

      function switchChat(index) {
        if (index < 0 || index >= chats.length) return;
        currentChat = index;
        renderSidebar();
        renderCurrentChat();
        saveChats();
      }

      function renderCurrentChat() {
        messages.innerHTML = "";
        chats[currentChat].messages.forEach((m) => {
          messages.appendChild(createMessageElement(m));
        });
        if (chats[currentChat].isTyping) {
          const typingWrapper = document.createElement("div");
          typingWrapper.className = "typing-indicator-wrapper";
          const typingIndicator = document.createElement("div");
          typingIndicator.className = "typing-indicator";
          typingIndicator.innerHTML = "<span></span><span></span><span></span>";
          typingWrapper.appendChild(typingIndicator);
          messages.appendChild(typingWrapper);
        }
        messages.scrollTop = messages.scrollHeight;
      }

      function renameChat(index) {
        const newName = prompt(
          "Digite o novo nome do chat:",
          chats[index].name
        );
        if (newName && newName.trim() !== "") {
          chats[index].name = newName.trim();
          renderSidebar();
          saveChats();
        }
      }

      function deleteChat(index) {
        if (
          confirm(`Tem certeza de que deseja apagar o chat "${chats[index].name}"?`)
        ) {
          chats.splice(index, 1);
          if (chats.length === 0) {
            newChat();
          } else {
            currentChat = Math.max(0, currentChat - 1);
            switchChat(currentChat);
          }
          saveChats();
          updatePinnedColumn();
        }
      }

      function renderSidebar() {
        sidebar.innerHTML = "";
        const userBtn = document.createElement("div");
        userBtn.className = "sidebar-btn";
        userBtn.innerHTML = `<span>👤 Usuário</span>`;
        userBtn.onclick = showUserProfile;
        sidebar.appendChild(userBtn);
        const pinnedBtn = document.createElement("div");
        pinnedBtn.className = "sidebar-btn";
        pinnedBtn.innerHTML = `<span>⭐ Fixados</span>`;
        pinnedBtn.onclick = togglePinnedColumn;
        sidebar.appendChild(pinnedBtn);
        chats.forEach((c, i) => {
          const btn = document.createElement("div");
          btn.className = "sidebar-btn" + (i === currentChat ? " active" : "");
          btn.innerHTML = `
        <span>${c.name}</span>
        <div class="sidebar-btn-options" onclick="event.stopPropagation(); showChatMenu(event, ${i})">...</div>
        <div id="chat-menu-${i}" class="chat-menu">
          <button onclick="renameChat(${i})">Renomear</button>
          <button onclick="deleteChat(${i})">Apagar</button>
        </div>
      `;
          btn.onclick = () => {
            switchChat(i);
            pinnedColumn.style.display = "none";
          };
          sidebar.appendChild(btn);
        });
        const newBtn = document.createElement("div");
        newBtn.className = "sidebar-btn";
        newBtn.textContent = "+ Novo Chat";
        newBtn.onclick = newChat;
        sidebar.appendChild(newBtn);
        const resetBtn = document.createElement("div");
        resetBtn.className = "sidebar-btn";
        resetBtn.textContent = "Apagar Tudo";
        resetBtn.style.backgroundColor = "#f44336";
        resetBtn.style.color = "#fff";
        resetBtn.onclick = clearAllChats;
        sidebar.appendChild(resetBtn);
      }

      function togglePinnedColumn() {
        const isVisible = pinnedColumn.style.display === "flex";
        pinnedColumn.style.display = isVisible ? "none" : "flex";
        if (!isVisible) {
          updatePinnedColumn();
        }
      }

      function showChatMenu(event, index) {
        document.querySelectorAll(".chat-menu").forEach((menu) => {
          menu.style.display = "none";
        });
        const menu = document.getElementById(`chat-menu-${index}`);
        menu.style.display = "flex";
      }

      document.addEventListener("click", function (event) {
        document.querySelectorAll(".chat-menu").forEach((menu) => {
          if (!menu.contains(event.target)) {
            menu.style.display = "none";
          }
        });
      });

      function downloadSingleMessage(text, type) {
        if (type === "pdf") {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text(text, 10, 10);
          doc.save("mensagem.pdf");
        } else if (type === "word") {
          const blob = new Blob([text], { type: "application/msword" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "mensagem.doc";
          link.click();
        }
      }

      async function downloadImage(imageUrl) {
        try {
          const response = await fetch(imageUrl);
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = `imagem_${Date.now()}.gif`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error("Erro ao baixar a imagem:", error);
          alert(
            "Não foi possível baixar a imagem. Por favor, tente novamente mais tarde."
          );
        }
      }

      function createMessageElement(messageData) {
        const { text, sender, pinned, fileName, id, chatIndex, isImage, isLinkList } =
          messageData;
        const wrapper = document.createElement("div");
        wrapper.className = "message-wrapper";
        wrapper.setAttribute("data-id", id);

        if (fileName) {
          const fileBanner = document.createElement("div");
          fileBanner.className = "file-sent-banner";
          fileBanner.innerText = `Documento: ${fileName}`;
          wrapper.appendChild(fileBanner);
        }

        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + sender;
        if (pinned) msgDiv.classList.add("pinned");

        if (isImage) {
          const imgElement = document.createElement("img");
          imgElement.src = text;
          imgElement.alt = "Imagem gerada por IA";
          msgDiv.appendChild(imgElement);
        } else if (isLinkList) {
          const title = document.createElement("p");
          title.innerHTML = `**Aqui estão alguns sites para "a sua pesquisa":**`;
          msgDiv.appendChild(title);
          const ul = document.createElement("ul");
          text.forEach((item) => {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = item.url;
            a.textContent = item.title || item.url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            li.appendChild(a);
            ul.appendChild(li);
          });
          msgDiv.appendChild(ul);
        } else {
          let formattedText = text.replace(
            /(https?:\/\/[^\s]+)/g,
            '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
          );
          formattedText = formattedText.replace(
            /\*\*(.*?)\*\*/g,
            "<strong>$1</strong>"
          );
          formattedText = formattedText.replace(/\*(.*?)\*/g, "<em>$1</em>");
          msgDiv.innerHTML = formattedText;
        }

        wrapper.appendChild(msgDiv);

        if (sender === "bot") {
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "msg-actions";

          const pinBtn = document.createElement("button");
          pinBtn.innerHTML = pinned ? "📌 Desafixar" : "📌 Fixar";
          pinBtn.onclick = () => pinMessage(id);
          actionsDiv.appendChild(pinBtn);

          const copyBtn = document.createElement("button");
          copyBtn.innerHTML = "📋 Copiar";
          copyBtn.onclick = () => copyMessage(text);
          actionsDiv.appendChild(copyBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "🗑 Apagar";
          deleteBtn.onclick = () => deleteMessage(id);
          actionsDiv.appendChild(deleteBtn);

          const downloadBtn = document.createElement("button");
          downloadBtn.innerHTML = "📥 Baixar";
          downloadBtn.onclick = () => showDownloadOptions(downloadBtn);
          actionsDiv.appendChild(downloadBtn);

          const dropdown = document.createElement("div");
          dropdown.className = "download-dropdown-content";
          dropdown.style.display = "none";

          const pdfBtn = document.createElement("button");
          pdfBtn.innerHTML = "PDF";
          pdfBtn.onclick = () => downloadSingleMessage(text, "pdf");
          dropdown.appendChild(pdfBtn);

          const wordBtn = document.createElement("button");
          wordBtn.innerHTML = "Word";
          wordBtn.onclick = () => downloadSingleMessage(text, "word");
          dropdown.appendChild(wordBtn);

          downloadBtn.parentElement.appendChild(dropdown);

          const brainstormBtn = document.createElement("button");
          brainstormBtn.innerHTML = "💡 Mapa de Ideias";
          brainstormBtn.onclick = () => openMermaidModal(text);
          actionsDiv.appendChild(brainstormBtn);

          msgDiv.appendChild(actionsDiv);
        } else {
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "msg-actions";
          actionsDiv.style.justifyContent = "flex-end";

          const editBtn = document.createElement("button");
          editBtn.innerHTML = "✏️ Editar";
          editBtn.onclick = () => editMessage(id, text);
          actionsDiv.appendChild(editBtn);

          const pinBtn = document.createElement("button");
          pinBtn.innerHTML = pinned ? "📌 Desafixar" : "📌 Fixar";
          pinBtn.onclick = () => pinMessage(id);
          actionsDiv.appendChild(pinBtn);

          const copyBtn = document.createElement("button");
          copyBtn.innerHTML = "📋 Copiar";
          copyBtn.onclick = () => copyMessage(text);
          actionsDiv.appendChild(copyBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "🗑 Apagar";
          deleteBtn.onclick = () => deleteMessage(id);
          actionsDiv.appendChild(deleteBtn);

          msgDiv.appendChild(actionsDiv);
        }
        return wrapper;
      }

      function showDownloadOptions(button) {
        const dropdown = button.parentElement.querySelector(".download-dropdown-content");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      }

      function openMermaidModal(text) {
        if (!mermaid) {
          alert("A biblioteca Mermaid não foi carregada. Tente novamente mais tarde.");
          return;
        }

        mermaid.render("mermaid-chart", `graph TD; A[Mensagem Original] --> B[Análise de Ideias]; B --> C[Ideia 1]; B --> D[Ideia 2];`).then(({ svg }) => {
          mermaidContainer.innerHTML = svg;
          mapModal.style.display = "block";
        });
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      function deleteMessage(messageId) {
        chats[currentChat].messages = chats[currentChat].messages.filter(
          (m) => m.id !== messageId
        );
        saveChats();
        renderCurrentChat();
      }

      function pinMessage(messageId) {
        const message = chats[currentChat].messages.find((m) => m.id === messageId);
        if (message) {
          message.pinned = !message.pinned;
          saveChats();
          renderCurrentChat();
          updatePinnedColumn();
        }
      }

      function updatePinnedColumn() {
        pinnedList.innerHTML = "";
        const pinnedMessages = chats.flatMap((chat, index) =>
          chat.messages.filter((m) => m.pinned).map((m) => ({ ...m, chatIndex: index }))
        );

        const filter = pinnedFilter.value;
        const filteredMessages = pinnedMessages.filter((m) => {
          if (filter === "all") return true;
          return m.sender === filter;
        });

        if (filteredMessages.length > 0) {
          filteredMessages.forEach((m) => {
            const btn = document.createElement("div");
            btn.className = "pinned-btn";
            btn.innerHTML = `<p>${m.text.substring(0, 50)}...</p>`;
            btn.onclick = () => {
              switchChat(m.chatIndex);
              setTimeout(() => {
                const element = document.querySelector(
                  `.message-wrapper[data-id="${m.id}"]`
                );
                if (element) {
                  element.scrollIntoView({ behavior: "smooth", block: "center" });
                  element.classList.add("highlight-message");
                  setTimeout(
                    () => element.classList.remove("highlight-message"),
                    2000
                  );
                }
              }, 500);
            };
            pinnedList.appendChild(btn);
          });
        } else {
          pinnedList.innerHTML = "<p>Nenhuma mensagem fixada.</p>";
        }
      }

      function filterPinned() {
        updatePinnedColumn();
      }

      function copyMessage(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("Mensagem copiada para a área de transferência!");
          })
          .catch((err) => {
            console.error("Erro ao copiar mensagem:", err);
            alert("Falha ao copiar a mensagem.");
          });
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          uploadedFile = file;
          fileNameSpan.textContent = file.name;
          fileInfoBar.style.display = "flex";
          fileMenuDropdown.style.display = "none";
          userInput.placeholder = `Pergunte sobre ${file.name}...`;
        }
      }

      function clearFileSelection() {
        uploadedFile = null;
        fileNameSpan.textContent = "";
        fileInfoBar.style.display = "none";
        userInput.placeholder = "Digite sua mensagem...";
      }

      function editMessage(id, oldText) {
        if (isEditing) return;
        isEditing = true;
        originalMessageId = id;

        const messageDiv = document.querySelector(
          `.message-wrapper[data-id="${id}"] .message`
        );
        const actionsContainer = document.querySelector(
          `.message-wrapper[data-id="${id}"] .msg-actions`
        );

        if (!messageDiv || !actionsContainer) {
          isEditing = false;
          return;
        }

        const editArea = document.createElement("textarea");
        editArea.className = "edit-textarea";
        editArea.value = oldText;

        const editActions = document.createElement("div");
        editActions.className = "edit-actions";

        const saveBtn = document.createElement("button");
        saveBtn.className = "save";
        saveBtn.textContent = "Salvar";
        saveBtn.onclick = () => saveEdit(id, editArea.value);

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "cancel";
        cancelBtn.textContent = "Cancelar";
        cancelBtn.onclick = () => cancelEdit();

        editActions.appendChild(saveBtn);
        editActions.appendChild(cancelBtn);

        messageDiv.replaceWith(editArea);
        actionsContainer.style.display = "none";
        editArea.after(editActions);
        editArea.focus();
      }

      function saveEdit(id, newText) {
        const messageIndex = chats[currentChat].messages.findIndex(
          (m) => m.id === id
        );
        if (messageIndex !== -1) {
          chats[currentChat].messages[messageIndex].text = newText;
          saveChats();
          renderCurrentChat();
        }
        isEditing = false;
        originalMessageId = null;
      }

      function cancelEdit() {
        const id = originalMessageId;
        const editArea = document.querySelector(
          `.message-wrapper[data-id="${id}"] .edit-textarea`
        );
        const editActions = document.querySelector(
          `.message-wrapper[data-id="${id}"] .edit-actions`
        );
        editArea.remove();
        editActions.remove();

        const actionsContainer = document.querySelector(
          `.message-wrapper[data-id="${id}"] .msg-actions`
        );
        actionsContainer.style.display = "flex";

        isEditing = false;
        renderCurrentChat();
      }

      async function sendMessage() {
        const userMessage = userInput.value.trim();
        if (userMessage === "" && !uploadedFile) return;
        if (isEditing) return;

        const messageId = Date.now().toString();
        const userMessageData = {
          id: messageId,
          text: userMessage,
          sender: "user",
          timestamp: new Date().toISOString(),
          pinned: false,
          fileName: uploadedFile ? uploadedFile.name : null,
        };

        chats[currentChat].messages.push(userMessageData);
        saveChats();
        renderCurrentChat();
        userInput.value = "";

        let conversationHistory = chats[currentChat].messages.map((msg) => {
          return { role: msg.sender === "user" ? "user" : "model", parts: [{ text: msg.text }] };
        });

        // Add typing indicator
        chats[currentChat].isTyping = true;
        renderCurrentChat();

        const generationConfig = {
          temperature: 0.9,
          topK: 1,
          topP: 1,
          maxOutputTokens: 2048,
        };

        const safetySettings = [{
          category: "HARM_CATEGORY_HARASSMENT",
          threshold: "BLOCK_MEDIUM_AND_ABOVE"
        }, {
          category: "HARM_CATEGORY_HATE_SPEECH",
          threshold: "BLOCK_MEDIUM_AND_ABOVE"
        }, {
          category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
          threshold: "BLOCK_MEDIUM_AND_ABOVE"
        }, {
          category: "HARM_CATEGORY_DANGEROUS_CONTENT",
          threshold: "BLOCK_MEDIUM_AND_ABOVE"
        }, ];

        const chatModel = puter.ai.GenerativeModel.fromModel("gemini-pro");

        let stream;
        try {
          stream = await chatModel.generateContent({
            contents: conversationHistory,
            generationConfig,
            safetySettings,
          });

          let botResponseText = '';
          for await (const chunk of stream.stream) {
            const chunkText = await chunk.text();
            if (chunkText) {
              botResponseText += chunkText;
              const typingIndicator = messages.querySelector(".typing-indicator-wrapper");
              if (typingIndicator) {
                messages.removeChild(typingIndicator);
              }
              const tempMessage = {
                id: Date.now().toString(),
                text: botResponseText,
                sender: "bot",
                timestamp: new Date().toISOString(),
                pinned: false,
              };
              messages.appendChild(createMessageElement(tempMessage));
              messages.scrollTop = messages.scrollHeight;
            }
          }
          const finalBotMessage = {
            id: Date.now().toString(),
            text: botResponseText,
            sender: "bot",
            timestamp: new Date().toISOString(),
            pinned: false,
          };
          chats[currentChat].messages.push(finalBotMessage);
          saveChats();
        } catch (err) {
          console.error("Error with AI model:", err);
          chats[currentChat].messages.push({
            id: Date.now().toString(),
            text: "Desculpe, não consegui gerar uma resposta no momento. Por favor, tente novamente mais tarde.",
            sender: "bot",
            timestamp: new Date().toISOString(),
            pinned: false,
          });
          saveChats();
        } finally {
          chats[currentChat].isTyping = false;
          renderCurrentChat();
        }
      }

      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !isEditing) {
          sendMessage();
        }
      });

      document
        .getElementById("send-btn")
        .addEventListener("click", () => sendMessage());

      document.getElementById("add-btn").addEventListener("click", () => {
        const dropdown = document.getElementById("file-menu-dropdown");
        dropdown.style.display =
          dropdown.style.display === "flex" ? "none" : "flex";
      });

      document.getElementById("btn-pdf").onclick = () => {
        uploadFile.accept = ".pdf";
        uploadFile.click();
      };
      document.getElementById("btn-word").onclick = () => {
        uploadFile.accept = ".doc,.docx";
        uploadFile.click();
      };
      document.getElementById("btn-txt").onclick = () => {
        uploadFile.accept = ".txt";
        uploadFile.click();
      };

      const themeToggleBtn = document.createElement("button");
      themeToggleBtn.innerText = "🌙";
      themeToggleBtn.style.cssText =
        "position: fixed; bottom: 20px; right: 20px; font-size: 24px; background: #fff; border-radius: 50%; width: 50px; height: 50px; border: 2px solid #ccc; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1);";
      themeToggleBtn.onclick = () => {
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        themeToggleBtn.innerText = isDarkMode ? "☀️" : "🌙";
        localStorage.setItem("theme", isDarkMode ? "dark" : "light");
      };
      document.body.appendChild(themeToggleBtn);
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
        themeToggleBtn.innerText = "☀️";
      } else {
        document.body.classList.remove("dark-mode");
        themeToggleBtn.innerText = "🌙";
      }

      document.getElementById("ask-button").addEventListener("click", () => {
        const text = `Quero criar uma página web que permita aos usuários se comunicarem com um assistente virtual. Preciso que a página tenha uma interface de login e cadastro, um chat principal onde possam enviar mensagens e receber respostas, um menu lateral para gerenciar conversas e um botão para fixar e apagar mensagens. Quero também ter a funcionalidade de fixar mensagens para revisão posterior, apagar mensagens individuais e apagar todo o chat. Adicionalmente, preciso que os usuários possam editar as próprias mensagens e fazer download do chat em PDF ou Word. Por favor, forneça o código HTML, CSS e JavaScript necessários para isso, incluindo a funcionalidade de comunicação com o assistente.`;
        userInput.value = text;
        sendMessage();
      });

      function showAskButton() {
        if (chats[currentChat].messages.length === 0) {
          askButton.style.display = "block";
        } else {
          askButton.style.display = "none";
        }
      }

      function searchMessages() {
        const query = searchInput.value.toLowerCase();
        const chatMessages = document.querySelectorAll(".message-wrapper");
        chatMessages.forEach((wrapper) => {
          const text = wrapper.textContent.toLowerCase();
          if (text.includes(query) || query === "") {
            wrapper.style.display = "flex";
          } else {
            wrapper.style.display = "none";
          }
        });
      }
    </script>
  </body>
</html>
